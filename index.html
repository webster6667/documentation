<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>

<body>

<script>
    //Поместить в доку
    // function sliceFile(file, chunksSize) {
    //     let chunks = []
    //
    //     for (let byteIndex = 0; byteIndex <= file.size;) {
    //         let byteEnd = byteIndex + chunksSize
    //
    //         chunks.push(file.slice(byteIndex, byteEnd));
    //         byteIndex += chunksSize
    //     }
    //
    //     return chunks;
    // }
</script>

<style>
    .progress-wrapper {
        position: relative;
        width: 300px;
        height: 20px;
        border: 1px solid black;
        overflow: hidden;
    }
    
    .progress-line {
        position: absolute;
        right: 100%;
        
        width: 100%;
        height: 100%;
        background: greenyellow;
    }
    
    .percent {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        font-weight: 600;
    }
    
</style>

<form id="my-form">
    
    <div class="progress-wrapper">
        <div class="progress-line"></div>
        <div class="percent">0%</div>
    </div>
    
    <br>
        
    <button type="submit" >
        Отправить
    </button>
    <button type="button" id="pause-btn" >
        Пауза
    </button>
</form>

<script>
    const str = 'Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquid commodi eos fugiat in ipsa iste modi nostrum qui repellendus tempore! A aliquid consequuntur laudantium maxime obcaecati reiciendis sit unde, ut?Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquid commodi eos fugiat in ipsa iste modi nostrum qui repellendus tempore! A aliquid consequuntur laudantium maxime obcaecati reiciendis sit unde, ut?Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquid commodi eos fugiat in ipsa iste modi nostrum qui repellendus tempore! A aliquid consequuntur laudantium maxime obcaecati reiciendis sit unde, ut?Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquid commodi eos fugiat in ipsa iste modi nostrum qui repellendus tempore! A aliquid consequuntur laudantium maxime obcaecati reiciendis sit unde, ut?Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquid commodi eos fugiat in ipsa iste modi nostrum qui repellendus tempore! A aliquid consequuntur laudantium maxime obcaecati reiciendis sit unde, ut?Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquid commodi eos fugiat in ipsa iste modi nostrum qui repellendus tempore! A aliquid consequuntur laudantium maxime obcaecati reiciendis sit unde, ut?Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquid commodi eos fugiat in ipsa iste modi nostrum qui repellendus tempore! A aliquid consequuntur laudantium maxime obcaecati reiciendis sit unde, ut?Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquid commodi eos fugiat in ipsa iste modi nostrum qui repellendus tempore! A aliquid consequuntur laudantium maxime obcaecati reiciendis sit unde, ut?Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquid commodi eos fugiat in ipsa iste modi nostrum qui repellendus tempore! A aliquid consequuntur laudantium maxime obcaecati reiciendis sit unde, ut?Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquid commodi eos fugiat in ipsa iste modi nostrum qui repellendus tempore! A aliquid consequuntur laudantium maxime obcaecati reiciendis sit unde, ut?Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquid commodi eos fugiat in ipsa iste modi nostrum qui repellendus tempore! A aliquid consequuntur laudantium maxime obcaecati reiciendis sit unde, ut?Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquid commodi eos fugiat in ipsa iste modi nostrum qui repellendus tempore! A aliquid consequuntur laudantium maxime obcaecati reiciendis sit unde, ut?Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquid commodi eos fugiat in ipsa iste modi nostrum qui repellendus tempore! A aliquid consequuntur laudantium maxime obcaecati reiciendis sit unde, ut?Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquid commodi eos fugiat in ipsa iste modi nostrum qui repellendus tempore! A aliquid consequuntur laudantium maxime obcaecati reiciendis sit unde, ut?Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquid commodi eos fugiat in ipsa iste modi nostrum qui repellendus tempore! A aliquid consequuntur laudantium maxime obcaecati reiciendis sit unde, ut?Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquid commodi eos fugiat in ipsa iste modi nostrum qui repellendus tempore! A aliquid consequuntur laudantium maxime obcaecati reiciendis sit unde, ut?Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquid commodi eos fugiat in ipsa iste modi nostrum qui repellendus tempore! A aliquid consequuntur laudantium maxime obcaecati reiciendis sit unde, ut?Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquid commodi eos fugiat in ipsa iste modi nostrum qui repellendus tempore! A aliquid consequuntur laudantium maxime obcaecati reiciendis sit unde, ut?Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquid commodi eos fugiat in ipsa iste modi nostrum qui repellendus tempore! A aliquid consequuntur laudantium maxime obcaecati reiciendis sit unde, ut?Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquid commodi eos fugiat in ipsa iste modi nostrum qui repellendus tempore! A aliquid consequuntur laudantium maxime obcaecati reiciendis sit unde, ut?Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquid commodi eos fugiat in ipsa iste modi nostrum qui repellendus tempore! A aliquid consequuntur laudantium maxime obcaecati reiciendis sit unde, ut?Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aliquid commodi eos fugiat in ipsa iste modi nostrum qui repellendus tempore! A aliquid consequuntur laudantium maxime obcaecati reiciendis sit unde, ut?',
          sliceFile = (file, chunksSize) => {
              let chunks = [],
                  order = 0

              for (let byteIndex = 0; byteIndex <= file.size;) {
                  let byteEnd = byteIndex + chunksSize

                  chunks.push({data: file.slice(byteIndex, byteEnd), order});
                  byteIndex += chunksSize
                  ++order
              }

              return chunks;
          }
    
    const form = document.getElementById('my-form'),
          url = 'http://localhost:5001/api/upload-entirely',
          progressLine = document.querySelector('.progress-line'),
          percent = document.querySelector('.percent'),
          pauseBtn = document.getElementById('pause-btn')
          
    
    let chunkList = [],
        abortController


    form.onsubmit = async (e) => {
        e.preventDefault();
        abortController = new AbortController();

        const file = new Blob([str], {type: 'text/plain'})

        if (!chunkList.length) {
            chunkList = sliceFile(file, 500)
        }

        let uploadedChunksCount = chunkList.filter(({isUploaded}) => isUploaded).length
        
        chunkList.forEach(({isUploaded = false}, index) => {
            
            if (!isUploaded) {
                fetch(url, {
                    method: 'POST',
                    signal: abortController.signal
                }).then((res) => res.json()).then((res) => {
                    ++uploadedChunksCount
                    chunkList[index].isUploaded = true;

                    const uploadedPercent = (uploadedChunksCount*100)/chunkList.length
                    progressLine.style.transform = `translateX(${uploadedPercent}%)`
                    percent.innerText = `${uploadedPercent}%`
                }).catch((e) => {
                    console.log(e);
                })
            }
            
            
        
        })
        
    };

    pauseBtn.onclick = () => {
        abortController.abort()
    }
</script>



</body>
</html>